images:
- &node_image node:lts 

npm-test:
  containers:
  - name: npm test
    image: *node_image
    env:
    - name: NODE_ENV
      value: development
    - name: BLUEBIRD_WARNINGS
      value: '0'
    args:
    - sh
    - -c
    - npm ci && npm run compile --if-present && npm run test --if-present
  output:
  - classifier: npm-test
    pattern:
      glob_pattern:
      - "*.{d.ts,js}{,.map}"
      - "!(node_modules)/**/*.{d.ts,js}{,.map}"
      - "lib/typings/types.ts"
      - "git-info.json"
  retry: true  

npm-publish:
  containers:
  - name: npm publish
    image: *node_image
    args:
    - sh
    - -c
    - npm publish --tag branch-${branch}
    secrets:
      file_mounts:
      - mount_path: /root/.npmrc
        value:
          provider:
            type: npm
  input:
  - version
  - npm-test
  retry: true
